name: MongoDB Integration Tests
on: [push, pull_request, repository_dispatch]
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.head_ref || '' }}-${{ github.base_ref || '' }}-${{ github.ref != 'refs/heads/main' || github.sha }}
  cancel-in-progress: true
defaults:
  run:
    shell: bash

jobs:
  linux-tests-mongodb:
    name: Run tests on Linux with MongoDB
    runs-on: ubuntu-latest
    strategy:
      matrix:
        duckdb_version: [ '<submodule_version>' ]
        arch: ['linux_amd64']
        include:
          - arch: 'linux_amd64'
            vcpkg_triplet: 'x64-linux'

    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ping:1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      VCPKG_TARGET_TRIPLET: ${{ matrix.vcpkg_triplet }}
      GEN: Ninja

    steps:
    - name: Install required ubuntu packages
      run: |
        sudo apt-get update -y -qq
        sudo apt-get install -y -qq build-essential cmake ninja-build ccache python3 python3-pip
        pip3 install pymongo
        # Ensure ninja is available in the path vcpkg expects
        which ninja || (echo "ninja not found in PATH" && find /usr -name ninja 2>/dev/null || true)
        # Create symlink if ninja is in /usr/bin but vcpkg expects /usr/local/bin
        if [ -f /usr/bin/ninja ] && [ ! -f /usr/local/bin/ninja ]; then
          sudo mkdir -p /usr/local/bin
          sudo ln -sf /usr/bin/ninja /usr/local/bin/ninja
        fi
        # Verify ninja is accessible and executable
        /usr/local/bin/ninja --version || /usr/bin/ninja --version
        # Ensure ninja is executable
        sudo chmod +x /usr/bin/ninja
        [ -f /usr/local/bin/ninja ] && sudo chmod +x /usr/local/bin/ninja || true
        # Add ninja directories to PATH for vcpkg (GITHUB_PATH persists across steps)
        echo "/usr/bin" >> $GITHUB_PATH
        echo "/usr/local/bin" >> $GITHUB_PATH

    - name: Install mongosh
      run: |
        wget -qO- https://www.mongodb.org/static/pgp/server-7.0.asc | sudo tee /etc/apt/trusted.gpg.d/server-7.0.asc
        echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
        sudo apt-get update
        sudo apt-get install -y mongodb-mongosh

    - name: Test MongoDB connection
      run: |
        mongosh --host localhost:27017 --eval "db.runCommand({ping:1})"

    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: 'true'

    - name: Checkout DuckDB to version
      if: ${{ matrix.duckdb_version != '<submodule_version>'}}
      run: |
        cd duckdb
        git checkout ${{ matrix.duckdb_version }}

    - name: Setup Ccache
      uses: hendrikmuhs/ccache-action@main
      with:
        key: ${{ github.job }}
        save: ${{ github.ref == 'refs/heads/main' || github.repository != 'stephaniewang526/duckdb-mongo' }}

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11.1
      with:
        # Use vcpkg commit with mongo-c-driver 1.30.3 which includes the CMP0042 fix.
        # The default commit (ce613c41372b23b1f51333815feb3edd87ef8a8b) has mongo-c-driver 1.30.2
        # which fails on macOS with CMake 4.0+ due to deprecated cmake_policy(SET CMP0042 OLD).
        # This is the immediate next commit after the default, minimizing risk of other breakage.
        vcpkgGitCommitId: 9aa0650e5c8d23fe66701bafb3ec03ac732a3ff1
      env:
        # Ensure ninja is available to vcpkg during setup
        PATH: /usr/bin:/usr/local/bin:$PATH
        CMAKE_MAKE_PROGRAM: /usr/bin/ninja

    - name: Build extension
      env:
        GEN: ninja
        VCPKG_TOOLCHAIN_PATH: ${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake
        CMAKE_MAKE_PROGRAM: /usr/bin/ninja
      run: |
        echo "VCPKG_TOOLCHAIN_PATH=$VCPKG_TOOLCHAIN_PATH"
        echo "VCPKG_TARGET_TRIPLET=$VCPKG_TARGET_TRIPLET"
        echo "CMAKE_MAKE_PROGRAM=$CMAKE_MAKE_PROGRAM"
        echo "ninja location: $(which ninja)"
        # Capture more detailed error output if build fails
        make release 2>&1 | tee build.log || (echo "=== Build failed, showing last 200 lines ===" && tail -200 build.log && exit 1)

    - name: Create MongoDB test data
      run: |
        set -e
        echo "Creating general test database..."
        bash test/create-mongo-tables.sh
        echo "Creating TPC-H test database (sf=0.01)..."
        bash test/create-tpch-test-db.sh
        echo "Verifying TPC-H test database was created..."
        mongosh --host localhost:27017 --eval "
          use tpch_test;
          const count = db.lineitem.countDocuments();
          if (count === 0) {
            print('ERROR: tpch_test.lineitem is empty!');
            quit(1);
          }
          print('✓ tpch_test.lineitem has ' + count + ' documents');
        "

    - name: Test extension
      env:
        MONGODB_TEST_DATABASE_AVAILABLE: 1
      run: |
        echo "Running all tests (ensuring no skips)..."
        make test_release 2>&1 | tee test.log
        # Verify tests completed successfully
        if ! grep -q "All tests passed" test.log; then
          echo "ERROR: Tests did not complete successfully!"
          exit 1
        fi
        # Extract test case count from "All tests passed (X assertions in Y test cases)"
        TEST_CASES=$(grep -oP '(?<=All tests passed \([0-9]+ assertions in )[0-9]+(?= test cases\))' test.log || echo "0")
        if [ "$TEST_CASES" -lt "13" ]; then
          echo "ERROR: Expected at least 13 test cases, but only $TEST_CASES ran!"
          echo "Some tests may have been skipped."
          exit 1
        fi
        # Check for any explicit skip messages (excluding the success message)
        if grep -i "skip" test.log | grep -v "All tests passed" | grep -v "test cases"; then
          echo "ERROR: Some tests were skipped!"
          grep -i "skip" test.log | grep -v "All tests passed" | grep -v "test cases"
          exit 1
        fi
        echo "✓ All $TEST_CASES test cases executed successfully (no skips)"

